---
title: '테이블 설계 마무리'
published: 2026-01-09
description: '테이블 설계는 어렵다'
author: 'necteo'
tags: ['Oracle', 'SQL']
category: 'SQL'
draft: false
---

테이블 설계에 시간이 많이 소모되서 우선 마무리 하려고 한다

```sql
-- 식품 별 분류
CREATE TABLE product_category (
    category_id     NUMBER,
    category_name   VARCHAR2(100) NOT NULL,  -- 팝콘/탄산/스낵
    CONSTRAINT pc_id_pk PRIMARY KEY(category_id),
    CONSTRAINT pc_name_uk UNIQUE(category_name)
);

-- 모든 식품 => 옵션에서 고를 수 있는 식품들
CREATE TABLE product_item (
    item_id     NUMBER,
    item_name   VARCHAR2(100) NOT NULL, -- 고소팝콘/셀프탄산
    category_id NUMBER,
    item_size   VARCHAR2(5), -- M/L
    item_price  NUMBER NOT NULL,    -- 식품 자체 가격
    base_item_id    NUMBER,  -- NULL: 기본, 값: 옵션
    add_price       NUMBER DEFAULT 0,   -- 옵션 추가금액
    item_regdate     DATE DEFAULT SYSDATE,
    item_moddate     DATE,
    CONSTRAINT pi_id_pk PRIMARY KEY(item_id),
    CONSTRAINT pi_cid_fk FOREIGN KEY(category_id) REFERENCES product_category(category_id),
    CONSTRAINT pi_bid_fk FOREIGN KEY(base_item_id) REFERENCES product_item(item_id),
    CONSTRAINT pi_size_ck CHECK(item_size IN ('M', 'L')),
    CONSTRAINT pi_price_ck CHECK(item_price >= 0),
    CONSTRAINT pi_add_ck CHECK(add_price >= 0),
    CONSTRAINT pi_logic_ck CHECK(
        (base_item_id IS NULL AND add_price = 0) OR -- 기본식품은 추가금액 0
        (base_item_id IS NOT NULL)  -- 옵션식품은 기본식품 참조
    )
);

CREATE INDEX idx_pi_category ON product_item(category_id);

-- 모든 상품 => 목록 출력용
CREATE TABLE store_product (
    product_id      NUMBER,
    product_name    VARCHAR2(100) NOT NULL,
    product_image   VARCHAR2(200),
    item_id         NUMBER,     -- 단품: 기본, 콤보: NULL
    product_price   NUMBER DEFAULT 0,   -- 기본금액
    discount        NUMBER DEFAULT 0,   -- 할인금액 (콤보)
    description     VARCHAR2(500) NOT NULL,
    is_combo        VARCHAR2(1) DEFAULT 'N', -- N: 단품/Y: 콤보
    CONSTRAINT sp_id_pk PRIMARY KEY(product_id),
    CONSTRAINT sp_iid_fk FOREIGN KEY(item_id) REFERENCES product_item(item_id),
    CONSTRAINT sp_combo_ck CHECK(is_combo IN ('Y', 'N')),
    CONSTRAINT sp_base_ck CHECK(product_price >= 0),
    CONSTRAINT sp_discount_ck CHECK(discount >= 0),
    CONSTRAINT sp_logic_ck CHECK(
        (is_combo = 'N' AND item_id IS NOT NULL) OR -- 단품은 item_id 필수
        (is_combo = 'Y' AND item_id IS NULL)    -- 콤보는 NULL
    )
);

-- 콤보 구성
CREATE TABLE product_combo (
    combo_id      NUMBER,
    product_id  NUMBER,
    item_id     NUMBER,     -- 기본 설정 식품
    is_upgrade  VARCHAR2(1) DEFAULT 'Y',    -- 사이즈 업그레이드 가능여부
    upgrade_price   NUMBER DEFAULT 0,   -- M => L 추가금액
    item_quantity    NUMBER DEFAULT 1,
    CONSTRAINT pcmb_id_pk PRIMARY KEY(combo_id),
    CONSTRAINT pcmb_pid_fk FOREIGN KEY(product_id) REFERENCES store_product(product_id),
    CONSTRAINT pcmb_iid_fk FOREIGN KEY(item_id) REFERENCES product_item(item_id),
    CONSTRAINT pcmb_upgrade_ck CHECK(is_upgrade IN ('Y', 'N')),
    CONSTRAINT pcmb_uprice_ck CHECK(upgrade_price >= 0),
    CONSTRAINT pcmb_quantity_ck CHECK(item_quantity > 0)
);

CREATE SEQUENCE seq_category_id
    START WITH 1
    INCREMENT BY 1
    NOCACHE
    NOCYCLE;
CREATE SEQUENCE seq_item_id
    START WITH 1
    INCREMENT BY 1
    NOCACHE
    NOCYCLE;
CREATE SEQUENCE seq_product_id
    START WITH 1
    INCREMENT BY 1
    NOCACHE
    NOCYCLE;
CREATE SEQUENCE seq_combo_id
    START WITH 1
    INCREMENT BY 1
    NOCACHE
    NOCYCLE;

-- 매점
CREATE TABLE store (
    store_id    NUMBER,
    theater_id  NUMBER NOT NULL,
    store_name  VARCHAR2(50) NOT NULL,
    CONSTRAINT st_id_pk PRIMARY KEY(store_id),
    CONSTRAINT st_tid_fk FOREIGN KEY(theater_id) REFERENCES theater(theater_id)
);

-- 재고
CREATE TABLE store_stock (
    stock_id    NUMBER,
    store_id    NUMBER,
    item_id     NUMBER,
    stock_quantity    NUMBER DEFAULT 0,
    stock_regdate     DATE DEFAULT SYSDATE,
    stock_moddate     DATE,
    CONSTRAINT ss_id_pk PRIMARY KEY(stock_id),
    CONSTRAINT ss_sid_fk FOREIGN KEY(store_id) REFERENCES store(store_id) ON DELETE CASCADE,
    CONSTRAINT ss_iid_fk FOREIGN KEY(item_id) REFERENCES product_item(item_id),
    CONSTRAINT ss_qty_ck CHECK(stock_quantity >= 0),
    CONSTRAINT ss_id_uk UNIQUE(store_id, item_id)
);

-- 주문
CREATE TABLE orders (
    order_id        NUMBER,
    member_id       NUMBER NOT NULL,
    store_id        NUMBER NOT NULL,
    total_price     NUMBER DEFAULT 0,
    order_state     VARCHAR2(20) DEFAULT '접수',
    regdate         DATE DEFAULT SYSDATE,
    moddate         DATE,
    CONSTRAINT ord_id_pk PRIMARY KEY(order_id),
    CONSTRAINT ord_mid_fk FOREIGN KEY(member_id) REFERENCES member(id),
    CONSTRAINT ord_sid_fk FOREIGN KEY(store_id) REFERENCES store(store_id),
    CONSTRAINT ord_price_ck CHECK(total_price >= 0),
    CONSTRAINT ord_state_ck CHECK(order_state IN ('접수', '거절', '준비중', '준비완료', '취소', '픽업완료'))
);

-- 주문 식품
CREATE TABLE order_product_item (
    order_product_id   NUMBER,
    order_id        NUMBER,
    product_id      NUMBER, -- 고른 식품의 기본 정보 / 콤보는 같은 product_id -> grouping
    item_id         NUMBER, -- 고른 item
    item_quantity   NUMBER DEFAULT 1,
    CONSTRAINT opi_id_pk PRIMARY KEY(order_product_id),
    CONSTRAINT opi_order_id FOREIGN KEY(order_id) REFERENCES orders(order_id),
    CONSTRAINT opi_product_id FOREIGN KEY(product_id) REFERENCES store_product(product_id),
    CONSTRAINT opi_item_id FOREIGN KEY(item_id) REFERENCES product_item(item_id),
    CONSTRAINT opi_qty_ck CHECK(item_quantity >= 0)
);

-- 장바구니
CREATE TABLE cart (
    cart_id     NUMBER,
    member_id   NUMBER,
    store_id    NUMBER,
    product_id  NUMBER,
    quantity    NUMBER DEFAULT 1,
    regdate     DATE DEFAULT SYSDATE,
    CONSTRAINT cart_id_pk PRIMARY KEY(cart_id),
    CONSTRAINT cart_mid_fk FOREIGN KEY(member_id) REFERENCES member(id) ON DELETE CASCADE,
    CONSTRAINT cart_sid_fk FOREIGN KEY(store_id) REFERENCES store(store_id),
    CONSTRAINT cart_pid_fk FOREIGN KEY(product_id) REFERENCES store_product(product_id),
    CONSTRAINT cart_qty_ck CHECK(quantity > 0)
);

-- 장바구니 식품
CREATE TABLE cart_item (
    cart_item_id    NUMBER,
    cart_id         NUMBER,
    item_id         NUMBER NOT NULL,
    quantity        NUMBER DEFAULT 1,
    CONSTRAINT ci_id_pk PRIMARY KEY(cart_item_id),
    CONSTRAINT ci_cid_fk FOREIGN KEY(cart_id) REFERENCES cart(cart_id) ON DELETE CASCADE,
    CONSTRAINT ci_iid_fk FOREIGN KEY(item_id) REFERENCES product_item(item_id),
    CONSTRAINT ci_qty_ck CHECK(quantity > 0)
);
```

솔직히 클로드의 도움을 꽤 받았지만

그냥 무턱대고 가져다 쓰는게 아니라

나와의 합의점을 찾아서 참조했다

예를 들면 작은 프로젝트라 식품 데이터가 변경될 일은 없는데

스냅샷을 고려해서 작성하거나 해서 그냥 쳐냈다

이젠 하다가 곤란해지면 그 때 수정하는게 좋을 것 같다

이제 UI 틀부터 잡고 식품 목록 출력부터 해보자..
