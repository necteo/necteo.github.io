---
layout: ../../layouts/MarkdownPostLayout.astro
title: '프로젝트 테이블 설계 2'
pubDate: 2026-01-06
description: '테이블 설계는 어렵다'
author: 'necteo'
tags: ['Oracle', 'SQL', 'learning in public']
---

다시 처음부터 설계

### 식품 목록 출력부터 상세보기, 옵션 선택까지의 테이블

```sql
-- 식품 별 분류
CREATE TABLE product_category (
    category_id     NUMBER,
    category_name   VARCHAR2(100) NOT NULL,  -- 팝콘/탄산/스낵
    CONSTRAINT pc_id_pk PRIMARY KEY(category_id),
    CONSTRAINT pc_name_uk UNIQUE(category_name)
);

-- 모든 식품 => 옵션에서 고를 수 있는 식품들
CREATE TABLE product_item (
    item_id     	NUMBER,
    item_name   	VARCHAR2(100) NOT NULL, -- 고소팝콘/셀프탄산
    category_id 	NUMBER,
    item_size   	VARCHAR2(5), -- M/L
    item_price  	NUMBER NOT NULL,    -- 식품 자체 가격 => base_item_id.item_price + add_price
    base_item_id  NUMBER,  -- NULL: 기본, 값: 옵션
    add_price     NUMBER DEFAULT 0,   -- 옵션 추가금액
    regdate     	DATE DEFAULT SYSDATE,
    moddate     	DATE,
    CONSTRAINT pi_id_pk PRIMARY KEY(item_id),
    CONSTRAINT pi_cid_fk FOREIGN KEY(category_id) REFERENCES product_category(category_id),
    CONSTRAINT pi_bid_fk FOREIGN KEY(base_item_id) REFERENCES product_item(item_id),
    CONSTRAINT pi_size_ck CHECK(item_size IN ('M', 'L')),
    CONSTRAINT pi_price_ck CHECK(item_price >= 0),
    CONSTRAINT pi_add_ck CHECK(add_price >= 0),
    CONSTRAINT pi_logic_ck CHECK(
        (base_item_id IS NULL AND add_price = 0) OR -- 기본식품은 추가금액 0
        (base_item_id IS NOT NULL)  -- 옵션식품은 기본식품 참조
    )
);

-- 모든 상품 => 목록 출력용
CREATE TABLE store_product (
    product_id      NUMBER,
    product_name    VARCHAR2(100) NOT NULL,
    product_image   VARCHAR2(200),
    item_id         NUMBER,     -- 단품: 기본, 콤보: NULL
    product_price   NUMBER DEFAULT 0,   -- 기본금액
    discount        NUMBER DEFAULT 0,   -- 할인금액 (콤보)
    description     VARCHAR2(500) NOT NULL,
    is_combo        CHAR(1) DEFAULT 'N', -- N: 단품/Y: 콤보 => 사실상 제약조건 체크용
    CONSTRAINT sp_id_pk PRIMARY KEY(product_id),
    CONSTRAINT sp_iid_fk FOREIGN KEY(item_id) REFERENCES product_item(item_id),
    CONSTRAINT sp_combo_ck CHECK(is_combo IN ('Y', 'N')),
    CONSTRAINT sp_base_ck CHECK(base_price >= 0),
    CONSTRAINT sp_discount_ck CHECK(discount >= 0),
    CONSTRAINT sp_logic_ck CHECK(
        (is_combo = 'N' AND item_id IS NOT NULL) OR -- 단품은 item_id 필수
        (is_combo = 'Y' AND item_id IS NULL)    -- 콤보는 NULL
    )
);

-- 콤보 구성
CREATE TABLE product_combo (
    combo_id      NUMBER,
    product_id  	NUMBER,
    item_id     	NUMBER,     -- 기본 설정 식품
    is_upgrade   	CHAR(1) DEFAULT 'Y',    -- 사이즈 업그레이드 가능여부
    upgrade_price NUMBER DEFAULT 0,   -- M => L 추가금액
    quantity    	NUMBER DEFAULT 1,
    CONSTRAINT pcmb_id_pk PRIMARY KEY(combo_id),
    CONSTRAINT pcmb_pid_fk FOREIGN KEY(product_id) REFERENCES store_product(product_id),
    CONSTRAINT pcmb_iid_fk FOREIGN KEY(item_id) REFERENCES product_item(item_id),
    CONSTRAINT pcmb_upgrade_ck CHECK(is_upgrade IN ('Y', 'N')),
    CONSTRAINT pcmb_uprice_ck CHECK(upgrade_price >= 0),
    CONSTRAINT pcmb_quantity_ck CHECK(quantity > 0)
);

CREATE SEQUENCE seq_category_id
    START WITH 1
    INCREMENT BY 1
    NOCACHE
    NOCYCLE;
CREATE SEQUENCE seq_item_id
    START WITH 1
    INCREMENT BY 1
    NOCACHE
    NOCYCLE;
CREATE SEQUENCE seq_product_id
    START WITH 1
    INCREMENT BY 1
    NOCACHE
    NOCYCLE;
CREATE SEQUENCE seq_combo_id
    START WITH 1
    INCREMENT BY 1
    NOCACHE
    NOCYCLE;
```

### 가장 고민했던 부분

- 콤보/단품 구별
- 옵션과 사이즈업 시 추가금액

### 흐름 구상

- 콤보/단품 구별

  - store_product.item_id에 값이 있으면 단품, null이면 콤보
  - 콤보는 구성 정보를 별도의 테이블로 관리
  - 단품은 product_item 테이블에서 바로 출력
  - 콤보는 product_combo를 참조해서 출력

- 옵션과 사이즈업
  - 단품의 옵션은 기본 식품을 설정해두고 => store_product.item_id가 null
  - 옵션 식품은 item_id가 null인 식품을 참조
  - 이때 옵션별로 추가금액을 add_price에 저장
  - 사이즈업은 단품은 불가능
  - 콤보 식품은 product_id를 참조하는 product_combo에서 item_id를 참조하고
    여기서 같은 category_id인 식품중 base_item_id가 null인 식품을 참조하고
    각 식품의 옵션을 모두 출력
  - M => L로 바뀌는 경우에는 product_combo.upgrade_price만큼 추가로 더한다 => product_item.add_price + product_combo.upgrade_price

우선 식품 자체 정보만 설계했다

구상해본대로 참조가 이루어질지는 아직 잘 모르겠지만 더는 지체하기 어렵기때문에 이대로 진행해야겠다.

다음은 주문과 재고관리 그리고 장바구니까지 설계하겠다.
